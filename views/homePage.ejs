<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>

    <!-- Google Font: CARDO -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cardo:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />

    <!-- Main CSS -->
    <link rel="stylesheet" href="/style.css" />
  </head>

  <body class="cardo-regular">
    <!-- Unplanned Box -->
    <div class="unplanned">
      <div class="unplannedBox"></div>
    </div>

    <!-- Date & Time overlay -->
    <div class="dateTime">
      <div class="dateTimeBox">
        <p id="currentDate"></p>
        <p id="currentTime"></p>
      </div>
    </div>

    <!-- Calendar Box -->
    <div class="calender">
      <div class="calenderBox">
        <div class="cal-header">
          <button id="prevMonth">â€¹</button>
          <p id="monthYear"></p>
          <button id="nextMonth">â€º</button>
        </div>

        <div class="cal-days">
          <span>Sun</span><span>Mon</span><span>Tue</span>
          <span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
        </div>

        <div class="cal-dates" id="calDates"></div>
      </div>
    </div>

    <!-- Timer Box -->
    <div class="timer">
      <p id="timerDisplay">01:00</p>
      <button id="startBtn">Start</button>
      <p id="timerMsg"></p>
    </div>

    <!-- Task List Box -->
    <div class="page">
      <div class="beige_box">
        <h1 class="cardo-bold">Welcome ðŸ‘‹</h1>
        <h3 class="cardo-regular">Your Todo List</h3>

        <div class="tasks">
          <div class="addtask">
            <form method="POST" action="/addTodo">
              <input type="text" name="todos" placeholder="Enter task" required />
              <button type="submit">Add</button>
            </form>
          </div>

          <div class="addToPage">
            <% if (work && work.tasks.length > 0) { %>
            <ul>
              <% for (let todo of work.tasks) { %>
              <li>
                <form method="POST" action="/toggleTodo" style="display:inline">
                  <input type="hidden" name="taskId" value="<%= todo._id %>" />
                  <input type="checkbox"
                    onchange="this.form.submit()"
                    <%= todo.isCompleted ? "checked" : "" %> />
                  <span class="<%= todo.isCompleted ? 'completed' : '' %>">
                    <%= todo.title %>
                  </span>
                </form>
              </li>
              <% } %>
            </ul>
            <% } else { %>
            <p>No tasks added for today</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Script -->
    <script>
      /* ---------------- DATE & TIME ---------------- */
      function updateDateTime() {
        const now = new Date();
        document.getElementById("currentDate").textContent =
          now.toLocaleDateString("en-IN", {
            weekday: "short",
            day: "2-digit",
            month: "short",
            year: "numeric",
          });

        document.getElementById("currentTime").textContent =
          now.toLocaleTimeString("en-IN", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);

      /* ---------------- AUDIO (FIXED) ---------------- */
      const alarm = new Audio("/sounds/alarm.wav");

      /* ---------------- TIMER ---------------- */
      let focusTime = 60;
      let timerInterval;

      const timerDisplay = document.getElementById("timerDisplay");
      const startBtn = document.getElementById("startBtn");
      const timerMsg = document.getElementById("timerMsg");

      function startTimer() {
        if (timerInterval) return;

        // unlock audio (browser requirement)
        alarm.play().then(() => {
          alarm.pause();
          alarm.currentTime = 0;
        }).catch(() => {});

        timerMsg.textContent = "Focus started â³";

        timerInterval = setInterval(() => {
          if (focusTime <= 0) {
            clearInterval(timerInterval);
            timerInterval = null;
            timerMsg.textContent = "Focus period completed ðŸ””";
            alarm.play(); // ðŸ”” plays correctly now
            return;
          }

          focusTime--;
          const m = Math.floor(focusTime / 60);
          const s = focusTime % 60;

          timerDisplay.textContent =
            String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
        }, 1000);
      }

      startBtn.addEventListener("click", startTimer);

      /* ---------------- CALENDAR ---------------- */
      const calDates = document.getElementById("calDates");
      const monthYear = document.getElementById("monthYear");
      const prevMonth = document.getElementById("prevMonth");
      const nextMonth = document.getElementById("nextMonth");

      let currentCalDate = new Date();

      function renderCalendar() {
        calDates.innerHTML = "";

        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        monthYear.textContent = currentCalDate.toLocaleDateString("en-IN", {
          month: "long",
          year: "numeric",
        });

        for (let i = 0; i < firstDay; i++) {
          calDates.appendChild(document.createElement("span"));
        }

        for (let d = 1; d <= lastDate; d++) {
          const dateEl = document.createElement("span");
          dateEl.textContent = d;

          dateEl.addEventListener("click", () => {
            const selectedDate = new Date(year, month, d);
            selectedDate.setHours(0, 0, 0, 0);
            loadTasksByDate(selectedDate.toISOString().split("T")[0]);
          });

          if (
            d === today.getDate() &&
            month === today.getMonth() &&
            year === today.getFullYear()
          ) {
            dateEl.classList.add("today");
          }

          calDates.appendChild(dateEl);
        }
      }

      prevMonth.onclick = () => {
        currentCalDate.setMonth(currentCalDate.getMonth() - 1);
        renderCalendar();
      };

      nextMonth.onclick = () => {
        currentCalDate.setMonth(currentCalDate.getMonth() + 1);
        renderCalendar();
      };

      renderCalendar();

      async function loadTasksByDate(dateStr) {
        const res = await fetch(`/tasks?date=${dateStr}`);
        const data = await res.json();

        const taskContainer = document.querySelector(".addToPage");
        taskContainer.innerHTML = "";

        if (data.tasks.length === 0) {
          taskContainer.innerHTML = "<p>No tasks for this date</p>";
          return;
        }

        const ul = document.createElement("ul");
        data.tasks.forEach((task) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <form method="POST" action="/toggleTodo" style="display:inline">
              <input type="hidden" name="taskId" value="${task._id}">
              <input type="checkbox" ${task.isCompleted ? "checked" : ""}
                onchange="this.form.submit()">
              <span class="${task.isCompleted ? "completed" : ""}">
                ${task.title}
              </span>
            </form>`;
          ul.appendChild(li);
        });

        taskContainer.appendChild(ul);
      }
    </script>
  </body>
</html>